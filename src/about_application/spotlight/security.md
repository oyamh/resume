# セキュリティ
## ログイン
- ログインにはSNS(GitHub, Google)のOAuth認証APIを使っています。
- ログインに使われるCookieはHttpOnly属性やSecure属性を使ってセキュアにしています。
- ログインにはJWT形式のStateトークンを使って、よりセキュアなログインを実現しています。
- ログインに必要な情報を、署名したStateトークンと隠匿されたCookieのみで完結させています。
    - ログイン処理に関して、データベースやキャッシュサーバーへのアクセスを必要としません。
    - 署名されたStateトークンに埋め込んだNonce値と、HttpOnlyなCookieのNonce値とを組み合わせたHash値を、Stateトークンに埋め込んだHash値と一致検証して、ログインの正当性を判定しています。
- メールアドレスによる認証では、独自に認証コードを発行して外部サービス経由のメールで送信しています。

## JWT
- 各サーバーとの通信にはJWT形式のアクセストークンを使用しています。
- アクセストークンの期限は短く設定し、より安全に保管しているリフレッシュトークンを使って再取得させています。

## Dockerコンテナ
- Docker Secretを使ってセキュアなImageを構築しています。
    - Docker SecretはImageの構築コマンド履歴に環境変数やSecretが残ってしまうのを防ぐために使われます。
        - 履歴を見られること（docker historyコマンド）によって、Imageに使われた環境変数やSecretが漏洩するのを防ぎます。

## ログインフローの例
### Googleアカウントを利用したログインフロー
クリックでMermaid Live Editorを開きます。
[![Googleアカウントを利用したログインフロー](https://mermaid.ink/img/pako:eNqFU01PwzAM_SuRTyDCR0vZRAQ7IXGCC-KCKlWh9dZobTKSdGJM---4LR0NTHCpHPv52c-ut5CbAkGAw7cGdY53Si6srFP97NCy09mMPaFdoxWsxKoyqX40Hpkhzz6wQI1Wkjc3Zqkw04Z4mNQF82aJun8fSiylK9ltmHbyX9K-mvP0zTr0zas9nx21dHxIJ0PVSJh6dZzqPrmT0-oS42QeVuyhpwTtkePuRlO5N2ZRIYUrhdpnquB_cHYqrFqUnpn5PtV5YzEE9qFRn7LxZdauKKA_sJ2_gK2YARfK-T3etaxU8WO8wfyG7kcFRzP4Mh3mFn2gZyjQUEOZ0nPD_9v0vpUD-wkoqVYLa5kPrFrmOToXKvler8W5RVcOYeBQo62lKugmtqlmLAVfYo0pCDILaZcppHpHOBqAedroHIS3DXJoVm2zX_cDYi4rR96V1C_G1AOIniC28A4ijuKzSRJfJtdxchlNkosJhw2I5CyZxtOraBJNO3e04_DREUQcsFD0zzz0F9sd7u4TrjJT0A?type=png)](https://mermaid.live/edit#pako:eNqFU01PwzAM_SuRTyDCR0vZRAQ7IXGCC-KCKlWh9dZobTKSdGJM---4LR0NTHCpHPv52c-ut5CbAkGAw7cGdY53Si6srFP97NCy09mMPaFdoxWsxKoyqX40Hpkhzz6wQI1Wkjc3Zqkw04Z4mNQF82aJun8fSiylK9ltmHbyX9K-mvP0zTr0zas9nx21dHxIJ0PVSJh6dZzqPrmT0-oS42QeVuyhpwTtkePuRlO5N2ZRIYUrhdpnquB_cHYqrFqUnpn5PtV5YzEE9qFRn7LxZdauKKA_sJ2_gK2YARfK-T3etaxU8WO8wfyG7kcFRzP4Mh3mFn2gZyjQUEOZ0nPD_9v0vpUD-wkoqVYLa5kPrFrmOToXKvler8W5RVcOYeBQo62lKugmtqlmLAVfYo0pCDILaZcppHpHOBqAedroHIS3DXJoVm2zX_cDYi4rR96V1C_G1AOIniC28A4ijuKzSRJfJtdxchlNkosJhw2I5CyZxtOraBJNO3e04_DREUQcsFD0zzz0F9sd7u4TrjJT0A)