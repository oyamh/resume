# セキュリティ
## ログイン
- ログインにはSNS(GitHub, Google)のOAuth認証APIを使っています。
- ログインに使われるCookieはHttpOnly属性やSecure属性を使ってセキュアにしています。
- ログインにはJWT形式のStateトークンを使って、よりセキュアなログインを実現しています。
    - 署名されたStateトークンに埋め込んだNonce値と、HttpOnlyなCookieのNonce値とを組み合わせたHash値を、Stateトークンに埋め込んだHash値と一致検証して、ログインの正当性を判定しています。
- メールアドレスによる認証では、独自に認証コードを発行して外部サービス経由のメールで送信しています。

## JWT
- 各サーバーとの通信にはJWT形式のアクセストークンを使用しています。
- アクセストークンの期限は短く設定し、より安全に保管しているリフレッシュトークンを使って再取得させています。

## Dockerコンテナ
- Docker Secretを使ってセキュアなImageを構築しています。
    - Docker SecretはImageの構築コマンド履歴に環境変数やSecretが残ってしまうのを防ぐために使われます。
        - 履歴を見られること（docker historyコマンド）によって、Imageに使われた環境変数やSecretが漏洩するのを防ぎます。

## ログインフローの例
### Googleアカウントを利用したログインフロー
クリックでMermaid Live Editorを開きます。
[![Googleアカウントを利用したログインフロー](https://mermaid.ink/img/pako:eNp9U8FOg0AQ_ZXNnDTB2mIrsDE9mXjSi_FiSMgK07Ip7NRlMWrTf3cAUVBSDmR39u2bN292DpBShiChwtcaTYq3Wm2tKmPzVKEVF-u1eET7hlaKHIuCYvNADgVx5Odgiwat4qgymagcWbx5sZfrQ0q005gYYlopHO3QdJvjSZbK8T9p4S3P2cZSKXoyryfihS6RweX-PDYdS6u3ES6HLN4wdw-9YGiHHMoclH1HtC1Yd1poNC7RmXeCsy3H6m3uBG1-rrZejIHd0UCnql2eND0Y0U_YfwrYFNPjxuX89_lNFTr74_PIv179IOHAg-9lhalFN6qnT1CzoESbDU15NC1loj8jSs7VwBrmiVarNMWqGlfy216LG4tV3h-DByXaUumMH_0hNkLE4HIsMQbJy0zZXQyxOTKODaDHD5OCdLZGD-p9I_Z7QPrgXplnouEW5AHeQfrzYBaE14u570fLyF-EoQcfIJezVXQVrsKAAwFjjh58tvfns6j7rlYLfxVE86UHmGl-QvfdhLaDevwCXlZMJA?type=png)](https://mermaid.live/edit#pako:eNp9U8FOg0AQ_ZXNnDTB2mIrsDE9mXjSi_FiSMgK07Ip7NRlMWrTf3cAUVBSDmR39u2bN292DpBShiChwtcaTYq3Wm2tKmPzVKEVF-u1eET7hlaKHIuCYvNADgVx5Odgiwat4qgymagcWbx5sZfrQ0q005gYYlopHO3QdJvjSZbK8T9p4S3P2cZSKXoyryfihS6RweX-PDYdS6u3ES6HLN4wdw-9YGiHHMoclH1HtC1Yd1poNC7RmXeCsy3H6m3uBG1-rrZejIHd0UCnql2eND0Y0U_YfwrYFNPjxuX89_lNFTr74_PIv179IOHAg-9lhalFN6qnT1CzoESbDU15NC1loj8jSs7VwBrmiVarNMWqGlfy216LG4tV3h-DByXaUumMH_0hNkLE4HIsMQbJy0zZXQyxOTKODaDHD5OCdLZGD-p9I_Z7QPrgXplnouEW5AHeQfrzYBaE14u570fLyF-EoQcfIJezVXQVrsKAAwFjjh58tvfns6j7rlYLfxVE86UHmGl-QvfdhLaDevwCXlZMJA)